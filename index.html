<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />

<meta name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#3B82F6">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="192x192" href="icon/icon_192.png">

<title>ã‚ã„ã†ãˆãŠ ã‚ˆã‚“ã§ï¼</title>
<style>

/* ã¯ã¿å‡ºã—é˜²æ­¢ã®åŸºæœ¬ */
*,*::before,*::after{ box-sizing:border-box; min-width:0; }
.panel, .boardWrap{ min-width:0; }   /* åˆ—ã®ç¸®å°ã‚’è¨±å¯ */

 :root{
  --panelW:300px;
  --panelCellH: 48px;
  --panelCellFS: 16px;
  --panelGap: 12px;
    --ink:#111; --muted:#dfe5ea;
    --key:72px; --gap:10px;
    --okSize:72px;
    /* åˆæœŸãƒ†ãƒ¼ãƒï¼šã‚ãŠ */
    --bg-strong:#e7f0ff; --accent:#3B82F6; --accentDark:#1E40AF;
    --wall:none; --wallOpacity:0; /* ğŸ“·ã‚«ã‚¹ã‚¿ãƒ èƒŒæ™¯ */
  }
 html,body{
   height:100%;margin:0;
   background-color: var(--bg-strong);
   background-image: var(--wall),
    linear-gradient(rgba(255,255,255,var(--wallOpacity)),rgba(255,255,255,var(--wallOpacity)));
   background-size: cover; background-position:center;
   color:var(--ink);
   font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif;
}
  
.app {
  position: relative;
  padding-bottom: 0;
  padding-bottom: constant(safe-area-inset-bottom);
  padding-bottom: env(safe-area-inset-bottom);
  height: 100svh;
  display: grid;
  grid-template-rows: auto auto 1fr;
  overflow: hidden;
}

@supports not (height: 100svh) {
  .app { height: 100vh; }
}

  header{padding:8px 12px}
  .display{margin:6px 12px;background:#fff;border:2px solid var(--muted);border-radius:16px;
    padding:12px;min-height:calc(var(--key)*0.9);font-size:calc(var(--key)*0.5);line-height:1.4;word-wrap:break-word}

header h1 {
  position: relative;
  font-size: 2.0em;
  font-weight: 900;
  display: flex;
  gap: 0.5em;           /* æ–‡å­—ã®é–“éš” */
  justify-content: center;
}

header h1 span {
  position: relative;
  z-index: 1;           /* æ–‡å­—ã‚’æœ€å‰é¢ã« */
}

header h1 span::before {
  content: "";
  position: absolute;
  inset: -0.5em;       /* ä¸¸ã®å¤§ãã•èª¿æ•´ */
  border-radius: 65%;   /* ä¸¸ã«ã™ã‚‹ */
  background: var(--accent);  /* å„ãƒ†ãƒ¼ãƒè‰²ã«è¿½å¾“ */
  z-index: -1;          /* èƒŒæ™¯ã«ç½®ã */
}

.deck{
  display:grid;
  grid-template-columns: minmax(0,1fr) minmax(0,var(--panelW));
  gap:12px;
  padding:8px 12px 12px;
  height:100%;
  min-height:0;
  overflow:hidden;
}

  /* ç”»é¢ãŒç‹­ã„/ç¸¦ã®ã¨ãã¯ãƒ‘ãƒãƒ«ã‚’ä¸‹ã«å›ã—ã¦1ã‚«ãƒ©ãƒ ã« */
@media (max-width: 850px) {
  .deck {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto;   /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å„ªå…ˆã§åºƒã */
  }
  .panel { order: 2; }              /* ãƒ‘ãƒãƒ«ã‚’ä¸‹ã« */
  .boardWrap { order: 1; }
}
  
.panel,.boardWrap{
  background:rgba(255,255,255,.70);
  border:3px solid var(--muted);
  border-radius:18px;
  padding:12px;
  height:100%;
  min-height:0;
}

.panel{
  display: flex;
  flex-direction: column;
  gap: var(--panelGap);
  overflow: auto;
}
.panel > .sliders {
  margin-top: auto;
  margin-bottom: auto;
}

.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--panelGap);}

.theme-controls {
  display: flex;
  flex-direction: column;
  gap: var(--panelGap);
}
.theme-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}
.themeBtn {
  aspect-ratio: 1 / 1;
  border-radius: 50%;
  border: 3px solid var(--muted);
  cursor: pointer;
  height: var(--panelCellH); 
  width:auto; aspect-ratio: unset;
}
#tRed    { background-color: #E84C3D; }
#tBlue   { background-color: #3B82F6; }
#tYellow { background-color: #ECA400; }
#tGreen  { background-color: #20C997; }
#tPink   { background-color: #E91E63; }

.customBtn {
  height: var(--panelCellH);
  border: 2px solid var(--accent);  /* â† ãƒ†ãƒ¼ãƒé€£å‹• */
  background: #fff;
  color: #234;
  border-radius: 14px;
  font-weight: 900;
  font-size: var(--panelCellFS);
  display: grid;
  place-items: center;
  cursor: pointer;
}
.fileInput { display: none; }

/* â–¼ å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼š2åˆ—=åŒã˜å¹…ã«ã€è‰²ã¯ãƒ†ãƒ¼ãƒé€£å‹• */
.voiceGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;   /* â† åŒã˜å¹…ã®2åˆ— */
  gap: var(--panelGap);
}
.voiceGrid select,
.voiceGrid button{
  height: var(--panelCellH);
  font-weight:800;
  font-size: var(--panelCellFS);
  width: 100%;
}

/* ã‚»ãƒ¬ã‚¯ãƒˆã®æ ã‚„ã‚´ãƒ¼ã‚¹ãƒˆç³»ãƒœã‚¿ãƒ³ã®æ ã‚’ãƒ†ãƒ¼ãƒè‰²ã« */
.voiceGrid select{
  grid-column: auto;                /* â† spanè§£é™¤ã—ã¦1åˆ—åˆ†ã« */
  border:2px solid var(--accent);   /* â† ãƒ†ãƒ¼ãƒé€£å‹• */
  border-radius:14px;
  background:#fff;
  color:#234;
  padding:0 10px;
}
.voiceGrid .btn.ghost{
  background:#fff;
  color:#234;
  border:2px solid var(--accent);   /* â† ãƒ†ãƒ¼ãƒé€£å‹• */
}
/* â–¼ iOSã§è§’ä¸¸ãŒåŠ¹ã‹ãªã„å¯¾ç­–ï¼šå¤–è¦³ãƒªã‚»ãƒƒãƒˆï¼‹è§’ä¸¸ã‚’å¼·åˆ¶ */
.voiceGrid .btn,
.voiceGrid .btn.ghost,
#reloadVoiceBtn {
  -webkit-appearance: none;
  appearance: none;
  border-radius: 14px;          /* è§’ä¸¸ã‚’ç¢ºå®Ÿã« */
  border: 2px solid var(--accent);
  background: #fff;
  color: #234;
}
.voiceGrid .btn,
#reloadVoiceBtn { width: 100%; 
}

.charToggle{
  border:3px solid #bfc9d7;
  background:#fff; color:#234;
  border-radius:16px;
  font-weight:900;
  transition: background-color .2s, color .2s, border-color .2s;
}
.actionRow .charToggle {
    grid-column: 4 / span 3;
    height: var(--okSize);
    font-size: calc(var(--key) * 0.28);
}
.actionRow .charToggle.on{
  background-color: var(--accentDark);
  color: #fff;
  border-color: var(--accentDark);
  box-shadow: none;
}

  .tenkey{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .nkey{
    width:100%;
    height:clamp(58px, calc(var(--panelW)/3 - 16px), 96px);
    border:2px solid var(--accent);border-radius:16px;background:#fff;font-weight:900;
    font-size:calc(var(--key)*0.5);color:#111; box-shadow:0 2px 0 rgba(0,0,0,.06)
  }
  .nkey.zero{grid-column:2}

  .editRow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .editBtn{
    height:var(--okSize); border-radius:16px; font-weight:900; font-size:18px;
    border:3px solid var(--accentDark); background:#fff; color:#000
  }
  .editBtn.primary{ background:var(--accentDark); color:#fff }

  .boardWrap{display:grid;grid-template-rows:auto 8px auto 8px auto;gap:0;overflow:hidden}
  
  .kanaGrid{
    display:grid;
    grid-template-columns:repeat(10,var(--key));
    gap:var(--gap);
    border-bottom: 2px solid var(--muted);
    padding-bottom: var(--gap);
  }
  .col{display:grid;grid-auto-rows:var(--key);gap:var(--gap)}
  .symRow{display:grid;grid-template-columns:repeat(10,var(--key));gap:var(--gap);align-items:center}

  .actionRow{display:grid;grid-template-columns:repeat(10,var(--key));gap:var(--gap);align-items:center}
  
  #questionKey {
    grid-column: 1 / span 1;
  }
  .spaceKey{
    grid-column: 2 / span 2;
    height:var(--okSize);
    border:2px solid #cfd7df;border-radius:16px;font-weight:900;
    font-size:calc(var(--key)*0.35);color:#111;
  }
  .okKey{
    grid-column: 7 / -1; 
    height:var(--okSize);
    border: 5px solid var(--accent);
    border-radius:20px;
    font-weight:900;
    font-size:calc(var(--key)*0.5);
    background:var(--accentDark);
    color:#fff;
    transition:background .08s,color .08s,transform .08s;
  }
  .okKey:active{ background:#fff; color:#000; transform:scale(.98) }

  .key{
    width:var(--key);height:var(--key);border:2px solid #cfd7df;border-radius:16px;
    display:grid;place-items:center;font-weight:900;font-size:calc(var(--key)*0.5);color:#111;box-shadow:0 2px 0 rgba(0,0,0,.08);
    cursor:pointer
  }

  .theme-red   { --bg-strong:#ffe3e3; --accent:#E84C3D; --accentDark:#C0392B }
  .theme-blue  { --bg-strong:#e7f0ff; --accent:#3B82F6; --accentDark:#1E40AF }
  .theme-yellow{ --bg-strong:#fff4bf; --accent:#ECA400; --accentDark:#B58100 }
  .theme-green { --bg-strong:#e6ffe6; --accent:#20C997; --accentDark:#0E9F6E }
  .theme-pink  { --bg-strong:#ffe0ef; --accent:#E91E63; --accentDark:#AD1457 }

  select{appearance:none}
  
  html, body, button { touch-action: manipulation; }
  
  .sliders{display:grid;grid-template-columns:80px 1fr;gap:12px 18px;align-items:center}
  .sliders label{text-align:center;line-height: 1.3;font-size: 14px;color:#444;font-weight:600;}
  input[type="range"]{width:100%;-webkit-appearance:none;height:14px;background:#e6eef7;border-radius:999px; outline:none;}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:34px;height:34px;border-radius:50%;background:#fff;border:3px solid var(--accent)}
  input[type="range"]::-moz-range-thumb{width:34px;height:34px;border-radius:50%;background:#fff;border:3px solid var(--accent)}
  
#animation-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  overflow: hidden;
  z-index: 999;
}
.emoji-float {
  position: absolute;
  bottom: -50px;
  font-size: 48px;
  animation-name: float-up;
  animation-timing-function: ease-out;
  animation-iteration-count: 1;
}

@keyframes float-up {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-80vh) scale(1.5); opacity: 0; }
}

  /* ===== ã‚¹ãƒãƒ›ã€œå°ã•ã‚iPadç¸¦å‘ã‘: 900pxä»¥ä¸‹ã§1ã‚«ãƒ©ãƒ ã« ===== */
@media (max-width: 900px) {
  /* ã‚¿ã‚¤ãƒˆãƒ«ã¯è‡ªå‹•ã§å°ã•ãï¼†æŠ˜ã‚Šè¿”ã—å¯ã« */
  header h1 {
    font-size: clamp(18px, 4.5vw, 28px);
    flex-wrap: wrap;
    gap: 0.35em;
  }
  header h1 span::before {
    inset: -0.4em;              /* ä¸¸ã®å¤§ãã•ã‚’å°‘ã—å°ã•ã‚ã« */
    border-radius: 999px;
  }

  /* å³ãƒ‘ãƒãƒ«ã‚’ä¸‹ã«ï¼šãƒ‡ãƒƒã‚­ã¯1ã‚«ãƒ©ãƒ  */
  .deck {
    grid-template-columns: 1fr;
    gap: 10px;
    padding: 8px 10px 10px;
    overflow: auto;             /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
  }
  /* ãƒ‘ãƒãƒ«ã¯é«˜ã•ã‚’è‡ªå‹•ã«ï¼ˆã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
  .panel {
    height: auto;
    max-height: none;
  }

  /* ä½™ç™½ã‚’å°‘ã—è©°ã‚ã‚‹ */
  :root {
    --panelGap: 10px;
    --gap: 8px;
  }

  /* è¡¨ç¤ºæ¬„ã‚‚å°‘ã—ã ã‘ä½ããƒ»æ–‡å­—ã‚‚è‡ªå‹•ç¸®å° */
  .display{
    min-height: calc(var(--key) * 0.8);
    font-size: clamp(16px, calc(var(--key) * 0.45), 24px);
  }

  /* ä¸‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ã®é«˜ã•ã‚’ã‚„ã‚„ä½ã */
  .spaceKey, .okKey, .actionRow .charToggle {
    height: calc(var(--okSize) * 0.9);
  }
}

/* ===== ã•ã‚‰ã«ç‹­ã„iPhoneç³»ï¼ˆ480pxä»¥ä¸‹ï¼‰ã®å¾®èª¿æ•´ ===== */
@media (max-width: 480px) {
  :root{
    --gap: 6px;
  }
  .display{
    min-height: calc(var(--key) * 0.7);
    font-size: clamp(14px, calc(var(--key) * 0.4), 20px);
  }
  .sliders label{ font-size: 12px; line-height: 1.2; }
  .nkey { height: clamp(52px, calc(var(--panelW)/3 - 18px), 88px); }
}
  /* ç¸¦å‘ããƒ–ãƒ­ãƒƒã‚¯ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ */
#rotateGate{
  position: fixed; inset: 0;
  display: none;
  place-items: center;
  background: rgba(255,255,255,.92);
  z-index: 2000;
}
#rotateGate .rotateBox{
  padding: 24px 28px;
  border: 3px solid var(--accent);
  border-radius: 16px;
  background: #fff;
  font-weight: 900;
  font-size: clamp(18px, 3.2vw, 28px);
  text-align: center;
  box-shadow: 0 8px 20px rgba(0,0,0,.12);
}

/* body ã« .portrait ãŒä»˜ã„ãŸã‚‰ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’éš ã—ã¦ã‚²ãƒ¼ãƒˆã‚’å‡ºã™ */
body.portrait .app{ visibility: hidden; }
body.portrait #rotateGate{ display: grid; }

</style>
</head>
<body class="theme-blue">
<div class="app">
  <div id="animation-overlay"></div>

 <header>
  <h1>
    <span>ã‚</span><span>ã„</span><span>ã†</span><span>ãˆ</span><span>ãŠ</span><span>ğŸ¤©</span>
    <span>ã‚ˆ</span><span>ã‚“</span><span>ã§</span><span>ï¼</span>
  </h1>
</header>

  <div class="display" id="display" aria-live="polite"></div>

  <div class="deck" id="deck">
    <section class="boardWrap">
      <div class="kanaGrid" id="kanaGrid"></div>
      <div></div>
      <div class="symRow" id="symRow"></div>
      <div></div>
      <div class="actionRow">
        <button class="key" id="questionKey">ï¼Ÿ</button>
        <button class="spaceKey" id="spaceBtn">ã‚¹ãƒšãƒ¼ã‚¹</button>
        <button class="charToggle" id="charToggleBtn">ã²ã¨ã‚‚ã˜ãšã¤ã‚ˆã‚€</button>
        <button class="okKey" id="okActionBtn">ã‚ˆã‚“ã§ï¼</button>
      </div>
    </section>

    <aside class="panel">
      <div class="theme-controls">
        <div class="theme-grid">
          <button class="themeBtn" id="tRed" aria-label="ãƒ†ãƒ¼ãƒ èµ¤"></button>
          <button class="themeBtn" id="tBlue" aria-label="ãƒ†ãƒ¼ãƒ é’"></button>
          <button class="themeBtn" id="tYellow" aria-label="ãƒ†ãƒ¼ãƒ é»„è‰²"></button>
          <button class="themeBtn" id="tGreen" aria-label="ãƒ†ãƒ¼ãƒ ç·‘"></button>
          <button class="themeBtn" id="tPink" aria-label="ãƒ†ãƒ¼ãƒ ãƒ”ãƒ³ã‚¯"></button>
        </div>
        <div class="g3">
            <label class="customBtn" for="bgPicker" style="grid-column: 1 / 3;">ğŸ–¼ï¸ã¯ã„ã‘ã„ã‚’ãˆã‚‰ã¶</label>
            <button class="customBtn" id="bgResetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <input id="bgPicker" class="fileInput" type="file" accept="image/*">
      </div>

      <div class="g3 voiceGrid">
        <select id="voiceSelect" aria-label="éŸ³å£°é¸æŠ"></select>
        <button class="btn ghost" id="reloadVoiceBtn">ãƒªãƒ­ãƒ¼ãƒ‰</button>
      </div>
      
      <div class="sliders">
        <label>ã“ãˆã®<br>ã¯ã‚„ã•</label><input type="range" id="rate" min="0.7" max="1.5" step="0.05" value="1.0">
        <label>ã“ãˆã®<br>ãŸã‹ã•</label><input type="range" id="pitch" min="0.7" max="1.6" step="0.05" value="1.0">
      </div>

      <div class="tenkey" id="tenkey"></div>

      <div class="editRow">
        <button class="editBtn primary" id="backspaceBtn">ã²ã¨ã‚‚ã˜<br>ã‘ã™</button>
        <button class="editBtn" id="clearBtn">ãœã‚“ã¶ã‘ã™</button>
      </div>
    </aside>
</div>

<script>
(function(){
  const display = document.getElementById('display');
  const rootStyle = document.documentElement.style;

  const cols = {
    "ã‚":["ã‚","ã„","ã†","ãˆ","ãŠ"], "ã‹":["ã‹","ã","ã","ã‘","ã“"],
    "ã•":["ã•","ã—","ã™","ã›","ã"], "ãŸ":["ãŸ","ã¡","ã¤","ã¦","ã¨"],
    "ãª":["ãª","ã«","ã¬","ã­","ã®"], "ã¯":["ã¯","ã²","ãµ","ã¸","ã»"],
    "ã¾":["ã¾","ã¿","ã‚€","ã‚","ã‚‚"], "ã‚„":["ã‚„","","ã‚†","","ã‚ˆ"],
    "ã‚‰":["ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚"], "ã‚":["ã‚","","ã‚’","","ã‚“"]
  };
  const order = ["ã‚","ã‚‰","ã‚„","ã¾","ã¯","ãª","ãŸ","ã•","ã‹","ã‚"];
  const kanaGrid = document.getElementById('kanaGrid');

  const symRow = document.getElementById('symRow');
  const SYMBOLS = ["ã‚›","ã‚œ","ã‚ƒ","ã‚…","ã‚‡","ã£","ãƒ¼","ã€","ã€‚","ï¼"];

  const PALETTES = {
    red:["#FF6B6B","#FF8E4D","#FF3D5A","#FFB04D","#E84C3D","#FF7043"],
    blue:["#4D9BFF","#22B8FF","#3B82F6","#00B8D9","#5C7CFA","#4DD0E1"],
    yellow:["#FFC93C","#FFB300","#FFD166","#ECA400","#FF9F1C","#F9C74F"],
    green:["#2ECC71","#20C997","#7BD88A","#00C853","#2ABF88","#1ABC9C"],
    pink:["#FF6FAE","#FF4DA6","#FF8BCB","#E91E63","#FF5D8F","#FF85B3"]
  };
  const BG = { red:"#ffe3e3", blue:"#e7f0ff", yellow:"#fff4bf", green:"#e6ffe6", pink:"#ffe0ef" };

  function speakCharacter(char) {
    if (!char) return;
    setTimeout(() => sayOnce(char, { rate: 1.2, pitch: 1.1 }), 50);
  }

  function makeKey(ch, onClick){
    const b=document.createElement('button'); b.className='key'; b.textContent=ch;
    b.addEventListener('click',()=>onClick(ch),{passive:true}); return b;
  }
  function buildKana(){
    kanaGrid.innerHTML="";
    order.forEach(name=>{
      const col=document.createElement('div'); col.className='col';
      cols[name].forEach(k=>{
        if(k===""){ const s=document.createElement('div'); s.style.width='var(--key)'; s.style.height='var(--key)'; s.style.visibility='hidden'; col.appendChild(s); }
        else col.appendChild(makeKey(k, insertText));
      });
      kanaGrid.appendChild(col);
    });
  }
  function buildSymbols(){ symRow.innerHTML=""; SYMBOLS.forEach(s=> symRow.appendChild(makeKey(s, handleSymbol))); }
  
  function insertText(t){
    display.textContent += t;
    speakCharacter(t);
  }
  const daku={"ã‹":"ãŒ","ã":"ã","ã":"ã","ã‘":"ã’","ã“":"ã”","ã•":"ã–","ã—":"ã˜","ã™":"ãš","ã›":"ãœ","ã":"ã","ãŸ":"ã ","ã¡":"ã¢","ã¤":"ã¥","ã¦":"ã§","ã¨":"ã©","ã¯":"ã°","ã²":"ã³","ãµ":"ã¶","ã¸":"ã¹","ã»":"ã¼"};
  const hand={"ã¯":"ã±","ã²":"ã´","ãµ":"ã·","ã¸":"ãº","ã»":"ã½"};
  const rd=Object.fromEntries(Object.entries(daku).map(([k,v])=>[v,k]));
  const rh=Object.fromEntries(Object.entries(hand).map(([k,v])=>[v,k]));
  
  function handleSymbol(s){
    if(s==="ã‚›"||s==="ã‚œ"){
      const arr=[...display.textContent]; if(!arr.length) return;
      const last=arr[arr.length-1];
      const rep=(s==="ã‚›")?(daku[last]||rd[last]):(hand[last]||rh[last]);
      if(rep){
        arr[arr.length-1]=rep;
        display.textContent=arr.join('');
        speakCharacter(rep);
      }
      return;
    }
    insertText(s);
  }

  function buildTenkey(){
    const tk=document.getElementById('tenkey'); tk.innerHTML="";
    ["1","2","3","4","5","6","7","8","9","","0",""].forEach(v=>{
      if(!v){ tk.appendChild(document.createElement('div')); return; }
      const b=document.createElement('button'); b.className='nkey'; b.textContent=v;
      if(v==="0") b.classList.add('zero');
      b.addEventListener('click',()=>insertText(v),{passive:true});
      tk.appendChild(b);
    });
  }

  function paintKeys(palette){
    const keys=document.querySelectorAll('.key, #questionKey');
    let i=0; keys.forEach(k=>{ k.style.backgroundColor = palette[i++ % palette.length]; });
    document.getElementById('spaceBtn').style.backgroundColor = palette[i % palette.length];
    document.querySelectorAll('.nkey').forEach((n,idx)=>{ n.style.backgroundColor = palette[(i+idx) % palette.length]; });
  }
  function setTheme(name){
    document.body.className = `theme-${name}`;
    rootStyle.setProperty('--bg-strong', BG[name]);
    paintKeys(PALETTES[name]);
  }

/* ğŸ“·ã‚«ã‚¹ã‚¿ãƒ èƒŒæ™¯ */
const bgPicker = document.getElementById('bgPicker');

// ç”»åƒé¸æŠæ™‚ã« base64 ã§ä¿å­˜
bgPicker.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const dataUrl = reader.result; // base64
    localStorage.setItem('bgImage', dataUrl);
    document.documentElement.style.setProperty('--wall', `url("${dataUrl}")`);
    document.documentElement.style.setProperty('--wallOpacity', .10);
  };
  reader.readAsDataURL(f);
});

// èµ·å‹•æ™‚ã«å¾©å…ƒ
const saved = localStorage.getItem('bgImage');
if (saved) {
  document.documentElement.style.setProperty('--wall', `url("${saved}")`);
  document.documentElement.style.setProperty('--wallOpacity', .10);
}

// èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½ã‚’è¿½åŠ 
const bgResetBtn = document.getElementById('bgResetBtn');
bgResetBtn.addEventListener('click', () => {
  localStorage.removeItem('bgImage'); // ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
  // CSSå¤‰æ•°ã‚’åˆæœŸå€¤ã«æˆ»ã™
  document.documentElement.style.setProperty('--wall', 'none');
  document.documentElement.style.setProperty('--wallOpacity', 0);
}, {passive:true});
  
let voices=[], jpVoice=null, warmed=false;
// â˜…åˆæœŸå€¤ã¯ falseã€‚å‰å›çŠ¶æ…‹ã‚‚å¾©å…ƒã§ãã‚‹ã‚ˆã†ã« localStorage ã‚’å‚ç…§
let charMode = (localStorage.getItem('charMode') ?? 'false') === 'true';

const voiceSel=document.getElementById('voiceSelect');
const charToggleBtn=document.getElementById('charToggleBtn');
  
  function uniqVoices(){
    const m=new Map();
    (speechSynthesis.getVoices()||[]).forEach(v=>{
      if(!/^ja(-|$)/i.test(v.lang)) return;
      const k=v.name+"|"+v.lang; if(!m.has(k)) m.set(k,v);
    }); return [...m.values()];
  }

  function populateVoices(){
    voices=uniqVoices(); voiceSel.innerHTML="";
    voices.forEach((v,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${v.name} (${v.lang})`; voiceSel.appendChild(o); });
    const idx=Math.max(0, voices.findIndex(v=>/kyoko|mizuki|nozomi|hina|sayaka|nanami|female|å¥³/i.test(v.name)));
    voiceSel.selectedIndex=idx; jpVoice=voices[idx]||null;
  }
  voiceSel.addEventListener('change',()=>{ jpVoice=voices[voiceSel.selectedIndex]||null; });
  function warm(){ if(warmed) return; const u=new SpeechSynthesisUtterance(" "); u.lang="ja-JP"; u.volume=0; speechSynthesis.speak(u); warmed=true; }

  function sayOnce(text, opts={}){
  try { speechSynthesis.resume(); } catch(e){}
  const u = new SpeechSynthesisUtterance(text || " ");
  if (jpVoice) u.voice = jpVoice;
  u.lang = (jpVoice && jpVoice.lang) || "ja-JP";
  const rate  = parseFloat(document.getElementById('rate')?.value || "1.0");
  const pitch = parseFloat(document.getElementById('pitch')?.value || "1.0");
  u.rate  = opts.rate  ?? rate;
  u.pitch = opts.pitch ?? pitch;
  speechSynthesis.speak(u);
  return new Promise(res=>{ u.onend=res; u.onerror=res; });
}

  async function speakCharByChar(t){
    const a=Array.from(t);
    for(let i=0;i<a.length;i++){
      let ch=a[i];
      if(" ã€ã€‚".includes(ch)){ await new Promise(r=>setTimeout(r,220)); continue; }
      if("ï¼Ÿï¼!?".includes(ch)){ await new Promise(r=>setTimeout(r,300)); continue; }
      if(i<a.length-1 && "ã‚ƒã‚…ã‚‡ã£ãƒ¼".includes(a[i+1])){ ch+=a[++i]; }
      await sayOnce(ch); 
      await new Promise(r=>setTimeout(r,40));
    }
  }
  
  function triggerEmojiAnimation(emojis) {
    const overlay = document.getElementById('animation-overlay');
    if (!overlay || !emojis) return;
    
    emojis.forEach((emoji, i) => {
      setTimeout(() => {
        const el = document.createElement('div');
        el.className = 'emoji-float';
        el.textContent = emoji;
        el.style.left = (Math.random() * 80 + 10) + '%';
        el.style.animationDuration = (Math.random() * 2 + 3) + 's';
        overlay.appendChild(el);
        el.addEventListener('animationend', () => { el.remove(); });
      }, i * 200);
    });
  }

  async function speak(){
    const t = display.textContent.trim();
    
    if(t === 'ã™ã'){ triggerEmojiAnimation(['â¤ï¸']); }
    else if(t === 'ã ã„ã™ã'){ triggerEmojiAnimation(['â¤ï¸', 'â¤ï¸', 'â¤ï¸']); }
    else if(t === 'ãŠã‚ã§ã¨ã†'){ triggerEmojiAnimation(['ğŸ‰', 'ğŸ¥³', 'ğŸŠ']); }
    else if(t === 'ã‚ã‚ŠãŒã¨ã†'){ triggerEmojiAnimation(['ğŸ˜Š', 'ğŸ™', 'ğŸ‘']); }
    else if(t === 'ã„ã„ã­'){ triggerEmojiAnimation(['ğŸ‘']); }
    else if(t === 'ã–ã‚“ã­ã‚“'){ triggerEmojiAnimation(['ğŸ˜¢']); }
    else if(t === 'ãŠã¯ã‚ˆã†'){ triggerEmojiAnimation(['â˜€ï¸']); }
    else if(t === 'ã“ã‚“ã«ã¡ã¯'){ triggerEmojiAnimation(['ğŸ¤—']); }
    else if(t === 'ã“ã‚“ã°ã‚“ã¯'){ triggerEmojiAnimation(['â­']); }
      
    else if(t === 'ã‚†ãš'){ triggerEmojiAnimation(['â­ï¸', 'ã‚†ãš', 'ğŸ˜ƒ']); }
    else if(t === 'ãã‚‹ã¿'){ triggerEmojiAnimation(['ğŸ€', 'ãã‚‹ã¿', 'ğŸ˜‰']); }
    else if(t === 'ã‚‚ã­'){ triggerEmojiAnimation(['ğŸ’–', 'ã‚‚ã­', 'ğŸ˜']); }
    else if(t === 'ã¯ã‚‹ã‹'){ triggerEmojiAnimation(['ğŸŒŸ', 'ã¯ã‚‹ã‹', 'ğŸ¥°']); }
    else if(t === 'ã¯ã‚‹ã¨'){ triggerEmojiAnimation(['ğŸ•º', 'ã¯ã‚‹ã¨', 'ğŸ˜']); }
      
    else if(t === 'ã†ã‚“ã“'){ triggerEmojiAnimation(['ğŸ’©']); }
    else if(t === 'ãŠãªã‚‰'){ triggerEmojiAnimation(['ğŸ’¨']); }
    else if(t === 'ãŠã—ã‚Š'){ triggerEmojiAnimation(['ğŸ«£']); }

    else if(t === 'ãã†'){ triggerEmojiAnimation(['ğŸ˜']); }
    else if(t === 'ã—ã¾ã†ã¾'){ triggerEmojiAnimation(['ğŸ¦“']); }
    else if(t === 'ãã‚Šã‚“'){ triggerEmojiAnimation(['ğŸ¦’']); }
    else if(t === 'ã±ã‚“ã '){ triggerEmojiAnimation(['ğŸ¼']); }
    else if(t === 'ã†ã•ã'){ triggerEmojiAnimation(['ğŸ°']); }
    else if(t === 'ã“ã‚ã‚‰'){ triggerEmojiAnimation(['ğŸ¨']); }
    else if(t === 'ã“ã¶ãŸ'){ triggerEmojiAnimation(['ğŸ·']); }
    else if(t === 'ãã¤ã­'){ triggerEmojiAnimation(['ğŸ¦Š']); }
    else if(t === 'ã­ã“'){ triggerEmojiAnimation(['ğŸ±']); }
    else if(t === 'ã„ã¬'){ triggerEmojiAnimation(['ğŸ¶']); }
    else if(t === 'ã‹ãˆã‚‹'){ triggerEmojiAnimation(['ğŸ¸']); }
    else if(t === 'ã‚‰ã„ãŠã‚“'){ triggerEmojiAnimation(['ğŸ¦']); }
    else if(t === 'ãŠã•ã‚‹'){ triggerEmojiAnimation(['ğŸ’']); }
    else if(t === 'ã•ã‚‹'){ triggerEmojiAnimation(['ğŸµ']); }
    else if(t === 'ã”ã‚Šã‚‰'){ triggerEmojiAnimation(['ğŸ¦']); }
    else if(t === 'ã†ã—'){ triggerEmojiAnimation(['ğŸ‚']); }
   
    else if(t === 'ã°ã‚ã°'){ triggerEmojiAnimation(['ğŸ‘µ']); }
    else if(t === 'ã˜ã„ã˜'){ triggerEmojiAnimation(['ğŸ‘´']); }
    else if(t === 'ã¯ã¯'){ triggerEmojiAnimation(['ğŸ§“']); }
   
    else if(t === 'ãŠã°ã‘'){ triggerEmojiAnimation(['ğŸ‘»']); }

    if(!t) return; warm();

    if(charMode){ await speakCharByChar(t); return; }
    
    const parts = t.split(/([ã€‚ï¼ï¼Ÿ!?])/);
    for(let i = 0; i < parts.length; i += 2){
      const seg = (parts[i] || "").trim();
      const p = (parts[i+1] || "");
      if(!seg && !p) continue;
      const excited = (p === "ï¼" || p === "!");
      await sayOnce(seg + p, { rate: excited ? 1.12 : undefined, pitch: excited ? 1.18 : undefined });
    }
  }

function autoFit(){
  const vw = innerWidth, vh = innerHeight;
  const portrait = vh > vw;

  // ãƒ‡ãƒƒã‚­ã®å·¦å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆ†ï¼ˆ12px * å·¦å³ + å†…éƒ¨ 12pxï¼‰
  const gutters = 12 + 12 + 12;
  const innerVW = Math.max(320, vw - gutters);

  // ç¸¦ï¼ˆç‹­ã„ï¼‰ã§ã¯1ã‚«ãƒ©ãƒ ãªã®ã§ãƒ‘ãƒãƒ«å¹…ã¯å…¨å¹…ã€æ¨ªã§ã¯å‰²åˆã§æ±ºã‚ã‚‹
  let panelW;
  if (portrait && vw < 900) {
    panelW = innerVW;                    // ç¸¦ã¯ä¸‹ã«å›ã™ã®ã§å¹…=100%
  } else {
    const ratio  = portrait ? 0.28 : 0.30;
    const minW   = portrait ? 170 : 190;
    const maxW   = portrait ? 300 : 320;
    panelW = Math.max(minW, Math.min(maxW, Math.round(innerVW * ratio)));
  }
  document.documentElement.style.setProperty('--panelW', panelW + 'px');

  const bw   = document.querySelector('.boardWrap');
  const leftW = bw.clientWidth;

  // ã¾ãšç¾åœ¨ã® gap ã‚’å–å¾—
  const rootStyles = getComputedStyle(document.documentElement);
  let gap = parseInt(rootStyles.getPropertyValue('--gap')) || 10;

  // 7æ®µï¼ˆã‹ãª5 + è¨˜å·1 + æ“ä½œ1ï¼‰ã€æ¨ª10åˆ—ã€é–“ã¯6æ®µ/9åˆ—ã®ã‚®ãƒ£ãƒƒãƒ—
  const totalRows  = 7, totalGaps = 6, spacersHeight = 8 + 8;
  const rowsH = bw.clientHeight - spacersHeight;

  // ç¾åœ¨ã®ã‚®ãƒ£ãƒƒãƒ—ã§è©¦ç®—
  let keyW = Math.floor((leftW - (10 - 1) * gap) / 10);
  let keyH = Math.floor((rowsH - totalGaps * gap) / totalRows);
  let key  = Math.min(keyW, keyH);

  // ç‹­ã™ãã‚‹æ™‚ã¯ã‚®ãƒ£ãƒƒãƒ—ã‚’è©°ã‚ã‚‹ï¼ˆ6pxï¼‰
  if (key < 50) {
    gap = 6;
    document.documentElement.style.setProperty('--gap', gap + 'px');
    keyW = Math.floor((leftW - (10 - 1) * gap) / 10);
    keyH = Math.floor((rowsH - totalGaps * gap) / totalRows);
    key  = Math.min(keyW, keyH);
  } else {
    document.documentElement.style.setProperty('--gap', '10px');
  }

  // æŒ‡ã®æœ€å°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ 36px ã¾ã§è¨±å®¹
  key = Math.max(36, Math.min(104, key));
  document.documentElement.style.setProperty('--key', key + 'px');
  document.documentElement.style.setProperty('--okSize', key + 'px');
}

  document.getElementById('questionKey').addEventListener('click', ()=>insertText('ï¼Ÿ'), {passive:true});
  document.getElementById('spaceBtn').addEventListener('click', ()=>insertText(' '), {passive:true});
  document.getElementById('okActionBtn').addEventListener('click', speak, {passive:true});
  document.getElementById('backspaceBtn').addEventListener('click', ()=>{
    const a=[...display.textContent]; a.pop(); display.textContent=a.join('');
  }, {passive:true});
  document.getElementById('clearBtn').addEventListener('click', ()=>{ display.textContent=""; }, {passive:true});
  document.getElementById('reloadVoiceBtn').addEventListener('click', ()=>{ warmed=false; warm(); setTimeout(populateVoices,120); }, {passive:true});

  document.getElementById('tRed').addEventListener('click', ()=>setTheme('red'));
  document.getElementById('tBlue').addEventListener('click', ()=>setTheme('blue'));
  document.getElementById('tYellow').addEventListener('click', ()=>setTheme('yellow'));
  document.getElementById('tGreen').addEventListener('click', ()=>setTheme('green'));
  document.getElementById('tPink').addEventListener('click', ()=>setTheme('pink'));

  // ã“ã“ã‚‚ç½®ãæ›ãˆ
function updateCharToggle(){
  charToggleBtn.classList.toggle('on', charMode);
  // ãƒ©ãƒ™ãƒ«ã‚’ã‚ã‹ã‚Šã‚„ã™ãï¼ˆä»»æ„ï¼‰
  charToggleBtn.textContent = charMode ? 'ã²ã¨ã‚‚ã˜ãšã¤ã‚ˆã‚€' : 'ãµã¤ã†ã«ã‚ˆã‚€';
}

document.getElementById('charToggleBtn').addEventListener('click', ()=>{
  charMode = !charMode;
  localStorage.setItem('charMode', String(charMode));   // â˜…ä¿å­˜
  updateCharToggle();
}, {passive:true});

  addEventListener('resize', autoFit); addEventListener('orientationchange', autoFit);

  function init(){
    buildKana(); buildSymbols(); buildTenkey(); setTheme('blue'); autoFit();
    if('speechSynthesis' in window){ 
      populateVoices(); 
      speechSynthesis.onvoiceschanged = populateVoices;
      setTimeout(populateVoices, 300);
      setTimeout(populateVoices, 1000);
    }
    updateCharToggle();
  }

function unlockTTS() {
  try {
    // Safari ãŒ paused ãªã“ã¨ãŒã‚ã‚‹
    speechSynthesis.resume();

    // ç„¡éŸ³ã§ä¸€åº¦ã‚­ãƒƒã‚¯
    const u = new SpeechSynthesisUtterance(" ");
    u.lang = "ja-JP";
    u.volume = 0;
    speechSynthesis.speak(u);
  } catch(e) {}

  // ãƒœã‚¤ã‚¹ã¯ä½•åº¦ã‹å†å–å¾—ï¼ˆiOSã¯éåŒæœŸã§é…ã‚Œã¦ãã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰
  populateVoices();
  setTimeout(populateVoices, 200);
  setTimeout(populateVoices, 800);

  // 1 å›è§£éŒ ã—ãŸã‚‰ãƒªã‚¹ãƒŠãƒ¼ã¯å¤–ã™
  ['touchstart','mousedown','keydown'].forEach(ev=>{
    document.removeEventListener(ev, unlockTTS, true);
  });
}
// capture: true ã«ã—ã¦ä¸€åº¦ã ã‘
['touchstart','mousedown','keydown'].forEach(ev=>{
  document.addEventListener(ev, unlockTTS, { once:true, capture:true });
});

// ã‚¿ãƒ–å¾©å¸°æ™‚ã«å‹æ‰‹ã« pause ã•ã‚Œã¦ã„ã‚‹å¯¾ç­–
document.addEventListener('visibilitychange', ()=>{
  if (!document.hidden) { try { speechSynthesis.resume(); } catch(e){} }
});

  init();
})();
</script>
  
<script>
(function(){
  function updateOrientationGate(){
    const isPortrait = window.matchMedia("(orientation: portrait)").matches;
    document.body.classList.toggle('portrait', isPortrait);
  }
  // åˆæœŸåŒ– & ç”»é¢å¤‰åŒ–ã§åæ˜ 
  updateOrientationGate();
  addEventListener('resize', updateOrientationGate, {passive:true});
  addEventListener('orientationchange', updateOrientationGate, {passive:true});
})();
</script>

<script>
(function(){
  const appEl = document.querySelector('.app');
  function fitToViewport(){
    const vv = window.visualViewport;
    if (vv && appEl){
      appEl.style.height = vv.height + 'px';
    }
  }
  if (window.visualViewport){
    visualViewport.addEventListener('resize', fitToViewport);
    visualViewport.addEventListener('scroll', fitToViewport);
    fitToViewport();
  }
})();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>

<div id="rotateGate" aria-hidden="true">
  <div class="rotateBox">
    ğŸ“± ãŸã¦å‘ãã§ã¯ ã¤ã‹ã„ã«ãã„ã‚ˆï¼<br>
    ï¼Š ã‚ˆã“å‘ã ã« ã—ã¦ã­ ï¼Š
  </div>
</div>
  
</body>
</html>
